<div class="item-list-container">
	<h2>Lista de itens disponíveis</h2>

	<!-- Selected Items Section -->
	<mat-card
		class="selected-items-card"
		*ngIf="selectedItems.length > 0"
	>
		<mat-card-header>
			<mat-card-title>
				<div class="selected-header">
					<span>
						<mat-icon>star</mat-icon>
						Itens Selecionados ({{ selectedItems.length }}/{{ 9 }})
					</span>
					<div class="header-actions">
						<button
							mat-icon-button
							(click)="toggleSelectedItems()"
							[matTooltip]="
								isSelectedItemsExpanded
									? 'Minimizar'
									: 'Expandir'
							"
						>
							<mat-icon>{{
								isSelectedItemsExpanded
									? 'expand_less'
									: 'expand_more'
							}}</mat-icon>
						</button>
						<button
							mat-icon-button
							color="warn"
							(click)="clearAllSelected()"
							matTooltip="Limpar todos"
						>
							<mat-icon>clear_all</mat-icon>
						</button>
					</div>
				</div>
			</mat-card-title>
		</mat-card-header>
		<mat-card-content
			[@expandCollapse]="
				isSelectedItemsExpanded ? 'expanded' : 'collapsed'
			"
		>
			<div
				class="selected-items-grid"
				*ngIf="isSelectedItemsExpanded"
			>
				<div
					class="selected-item-card"
					*ngFor="let item of selectedItems"
				>
					<button
						mat-icon-button
						class="remove-btn"
						(click)="removeSelectedItem(item)"
					>
						<mat-icon>close</mat-icon>
					</button>
					<img
						[src]="getImageUrl(item)"
						[alt]="item.name"
						class="selected-item-image"
						(error)="onImageError($event)"
					/>
					<div class="selected-item-info">
						<h4>{{ item.name }}</h4>
						<div class="creatures-mini-container">
							<mat-chip
								*ngFor="let creature of item.droppedBy"
								class="creature-chip-mini"
							>
								<a
									[href]="getCreatureWikiUrl(creature)"
									target="_blank"
									rel="noopener noreferrer"
									class="creature-link"
								>
									{{ creature }}
								</a>
							</mat-chip>
						</div>
						<p class="sell-info">{{ item.sellTo }}</p>
						<p class="price-info">{{ item.price }} gp</p>
					</div>
				</div>
			</div>
		</mat-card-content>
	</mat-card>

	<mat-card>
		<mat-card-content>
			<!-- Search Input -->
			<div class="search-container">
				<mat-form-field
					appearance="outline"
					class="search-field"
				>
					<mat-label>Pesquisar item</mat-label>
					<input
						#searchInput
						matInput
						[formControl]="searchControl"
						placeholder="Digite o nome do item..."
						autocomplete="off"
					/>
					<mat-icon matPrefix>search</mat-icon>
					<button
						mat-icon-button
						matSuffix
						*ngIf="searchControl.value"
						(click)="searchControl.setValue('')"
						aria-label="Limpar"
					>
						<mat-icon>close</mat-icon>
					</button>
				</mat-form-field>

				<mat-checkbox
					[(ngModel)]="filterYasir"
					(change)="onYasirFilterChange()"
					class="yasir-filter"
					name="filterYasir"
				>
					Apenas Yasir
				</mat-checkbox>
			</div>

			<!-- Loading Spinner -->
			<div
				class="loading-container"
				*ngIf="loading"
			>
				<mat-spinner></mat-spinner>
				<p>Carregando itens...</p>
			</div>

			<!-- Items Table -->
			<div
				class="table-container"
				*ngIf="!loading"
			>
				<table
					mat-table
					[dataSource]="items"
					class="items-table"
				>
					<!-- Select Column -->
					<ng-container matColumnDef="select">
						<th
							mat-header-cell
							*matHeaderCellDef
						>
							Selecionar
						</th>
						<td
							mat-cell
							*matCellDef="let item"
						>
							<mat-checkbox
								[checked]="isItemSelected(item)"
								[disabled]="
									!isItemSelected(item) && !canSelectMore()
								"
								(change)="toggleItemSelection(item)"
								[matTooltip]="
									!canSelectMore() && !isItemSelected(item)
										? 'Máximo de 9 itens atingido'
										: ''
								"
							>
							</mat-checkbox>
						</td>
					</ng-container>

					<!-- Image Column -->
					<ng-container matColumnDef="image">
						<th
							mat-header-cell
							*matHeaderCellDef
						>
							Imagem
						</th>
						<td
							mat-cell
							*matCellDef="let item"
						>
							<img
								[src]="getImageUrl(item)"
								[alt]="item.name"
								class="item-image"
								(error)="onImageError($event)"
							/>
						</td>
					</ng-container>

					<!-- Name Column -->
					<ng-container matColumnDef="name">
						<th
							mat-header-cell
							*matHeaderCellDef
						>
							Nome
						</th>
						<td
							mat-cell
							*matCellDef="let item"
						>
							<strong>{{ item.name }}</strong>
						</td>
					</ng-container>

					<!-- Dropped By Column -->
					<ng-container matColumnDef="droppedBy">
						<th
							mat-header-cell
							*matHeaderCellDef
						>
							Dropa de
						</th>
						<td
							mat-cell
							*matCellDef="let item"
						>
							<div class="creatures-container">
								<mat-chip
									*ngFor="let creature of item.droppedBy"
									class="creature-chip"
								>
									<a
										[href]="getCreatureWikiUrl(creature)"
										target="_blank"
										rel="noopener noreferrer"
										class="creature-link"
									>
										{{ creature }}
										<mat-icon class="external-link-icon"
											>open_in_new</mat-icon
										>
									</a>
								</mat-chip>
							</div>
						</td>
					</ng-container>

					<!-- Sell To Column -->
					<ng-container matColumnDef="sellTo">
						<th
							mat-header-cell
							*matHeaderCellDef
						>
							Vende Para
						</th>
						<td
							mat-cell
							*matCellDef="let item"
						>
							{{ item.sellTo }}
						</td>
					</ng-container>

					<!-- Price Column -->
					<ng-container matColumnDef="price">
						<th
							mat-header-cell
							*matHeaderCellDef
						>
							Preço
						</th>
						<td
							mat-cell
							*matCellDef="let item"
							class="price-cell"
						>
							<span class="price-value">{{ item.price }} gp</span>
						</td>
					</ng-container>

					<tr
						mat-header-row
						*matHeaderRowDef="displayedColumns"
					></tr>
					<tr
						mat-row
						*matRowDef="let row; columns: displayedColumns"
					></tr>

					<!-- No Data Row -->
					<tr
						class="mat-row no-data-row"
						*matNoDataRow
					>
						<td
							class="mat-cell"
							[attr.colspan]="displayedColumns.length"
						>
							<div class="no-data">
								<mat-icon>inbox</mat-icon>
								<p *ngIf="searchControl.value">
									Nenhum item encontrado para "{{
										searchControl.value
									}}"
								</p>
								<p *ngIf="!searchControl.value">
									Nenhum item disponível
								</p>
							</div>
						</td>
					</tr>
				</table>

				<!-- Loading More Indicator -->
				<div
					class="loading-more"
					*ngIf="loadingMore"
				>
					<mat-spinner diameter="40"></mat-spinner>
					<p>Carregando mais itens...</p>
				</div>

				<!-- Results Counter -->
				<div
					class="results-info"
					*ngIf="items.length > 0"
				>
					<p>
						Mostrando {{ items.length }} de
						{{ totalElements }} itens
					</p>
				</div>

				<!-- End of List Message -->
				<div
					class="end-of-list"
					*ngIf="!hasMore && items.length > 0"
				>
					<p>✓ Todos os itens foram carregados</p>
				</div>
			</div>
		</mat-card-content>
	</mat-card>
</div>
